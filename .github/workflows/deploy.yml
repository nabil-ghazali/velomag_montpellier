name: Build & Deploy Full App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # ========================================
  # JOB 1 : BACKEND
  # ========================================
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4

      - name: Connexion à Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/velomag_montpellier-backend:latest

      - name: Déploiement Azure (Backend)
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'velomag-backend' 
          publish-profile: ${{ secrets.AZURE_BACKEND_PUBLISH_PROFILE }}
          images: '${{ secrets.DOCKER_USERNAME }}/velomag_montpellier-backend:latest'

  # ========================================
  # JOB 2 : FRONTEND
  # ========================================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend 
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4

      - name: Connexion à Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/velomag_montpellier-frontend:latest

      - name: ☁️ Déploiement Azure (Frontend)
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'velomag-frontend'
          publish-profile: ${{ secrets.AZURE_FRONTEND_PUBLISH_PROFILE }}
          images: '${{ secrets.DOCKER_USERNAME }}/velomag_montpellier-frontend:latest'